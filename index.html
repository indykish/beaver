<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <title>Beaver by josegonzalez</title>
  </head>

  <body>
    <div id="container">
      <div class="inner">

        <header>
          <h1>Beaver</h1>
          <h2>python daemon that munches on logs and sends their contents to logstash</h2>
        </header>

        <section id="downloads" class="clearfix">
          <a href="https://github.com/josegonzalez/beaver/zipball/master" id="download-zip" class="button"><span>Download .zip</span></a>
          <a href="https://github.com/josegonzalez/beaver/tarball/master" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
          <a href="https://github.com/josegonzalez/beaver" id="view-on-github" class="button"><span>View on GitHub</span></a>
        </section>

        <hr>

        <section id="main_content">
          <h1>Requirements</h1>

<ul>
<li>Python 2.6+</li>
<li>Optional zeromq support: install libzmq (<code>brew install zmq</code> or <code>apt-get install libzmq-dev</code>) and pyzmq (<code>pip install pyzmq==2.1.11</code>)</li>
</ul><h1>Installation</h1>

<p>Using PIP:</p>

<p>From Github::</p>

<pre><code>pip install git+git://github.com/josegonzalez/beaver.git#egg=beaver
</code></pre>

<p>From PyPI::</p>

<pre><code>pip install beaver==29
</code></pre>

<h1>Usage</h1>

<p>usage::</p>

<pre><code>beaver [-h] [-c CONFIG] [-d] [-D] [-f FILES [FILES ...]]
       [-F {json,msgpack,raw,rawjson,string}] [-H HOSTNAME] [-m {bind,connect}]
       [-l OUTPUT] [-p PATH] [-P PID]
       [-t {mqtt,rabbitmq,redis,sqs,stdout,udp,zmq}] [-v] [--fqdn]
</code></pre>

<p>optional arguments::</p>

<pre><code>-h, --help            show this help message and exit
-c CONFIG, --configfile CONFIG
                      ini config file path
-d, --debug           enable debug mode
-D, --daemonize       daemonize in the background
-f FILES [FILES ...], --files FILES [FILES ...]
                      space-separated filelist to watch, can include globs
                      (*.log). Overrides --path argument
-F {json,msgpack,raw,rawjson,string}, --format {json,msgpack,raw,rawjson,string}
                      format to use when sending to transport
-H HOSTNAME, --hostname HOSTNAME
                      manual hostname override for source_host
-m {bind,connect}, --mode {bind,connect}
                      bind or connect mode
-l OUTPUT, --logfile OUTPUT, -o OUTPUT, --output OUTPUT
                      file to pipe output to (in addition to stdout)
-p PATH, --path PATH  path to log files
-P PID, --pid PID     path to pid file
-t {mqtt,rabbitmq,redis,stdout,udp,zmq}, --transport {mqtt,rabbitmq,redis,sqs,stdout,udp,zmq}
                      log transport method
-v, --version         output version and quit
--fqdn                use the machine's FQDN for source_host
</code></pre>

<h1>Background</h1>

<p>Beaver provides an lightweight method for shipping local log files to Logstash. It does this using redis, zeromq, udp, rabbit or stdout as the transport. This means you'll need a redis, zeromq, udp, amqp or stdin input somewhere down the road to get the events.</p>

<p>Events are sent in logstash's <code>json_event</code> format. Options can also be set as environment variables.</p>

<p>NOTE: the redis transport uses a namespace of <code>logstash:beaver</code> by default.  You will need to update your logstash indexer to match this, or you may configure beaver to do otherwise.</p>

<h2>Configuration File Options</h2>

<p>Beaver can optionally get data from a <code>configfile</code> using the <code>-c</code> flag. This file is in <code>ini</code> format. Global configuration will be under the <code>beaver</code> stanza. The following are global beaver configuration keys with their respective meanings:</p>

<ul>
<li>mqtt_host: Default <code>localhost</code>. Host for mosquitto</li>
<li>mqtt_port: Default <code>1883</code>. Port for mosquitto</li>
<li>mqtt_clientid: Default <code>mosquitto</code>. Mosquitto client id</li>
<li>mqtt_keepalive: Default <code>60</code>. mqtt keepalive ping</li>
<li>mqtt_topic: Default <code>/logstash</code>. Topic to publish to</li>
<li>rabbitmq_host: Defaults <code>localhost</code>. Host for RabbitMQ</li>
<li>rabbitmq_port: Defaults <code>5672</code>. Port for RabbitMQ</li>
<li>rabbitmq_vhost: Default <code>/</code>
</li>
<li>rabbitmq_username: Default <code>guest</code>
</li>
<li>rabbitmq_password: Default <code>guest</code>
</li>
<li>rabbitmq_queue: Default <code>logstash-queue</code>.</li>
<li>rabbitmq_exchange_type: Default <code>direct</code>.</li>
<li>rabbitmq_exchange_durable: Default <code>0</code>.</li>
<li>rabbitmq_key: Default <code>logstash-key</code>.</li>
<li>rabbitmq_exchange: Default <code>logstash-exchange</code>.</li>
<li>redis_url: Default <code>redis://localhost:6379/0</code>. Redis URL</li>
<li>redis_namespace: Default <code>logstash:beaver</code>. Redis key namespace</li>
<li>sqs_aws_access_key: Can be left blank to use IAM Roles or AWS_ACCESS_KEY_ID environment variable (see: <a href="https://github.com/boto/boto#getting-started-with-boto">https://github.com/boto/boto#getting-started-with-boto</a>)</li>
<li>sqs_aws_secret_key: Can be left blank to use IAM Roles or AWS_SECRET_ACCESS_KEY environment variable (see: <a href="https://github.com/boto/boto#getting-started-with-boto">https://github.com/boto/boto#getting-started-with-boto</a>)</li>
<li>sqs_aws_region: Default <code>us-east-1</code>. AWS Region</li>
<li>sqs_aws_queue: SQS queue (must exist)</li>
<li>udp_host: Default <code>127.0.0.1</code>. UDP Host</li>
<li>udp_port: Default <code>9999</code>. UDP Port</li>
<li>zeromq_address: Default <code>tcp://localhost:2120</code>. Zeromq URL</li>
<li>zeromq_hwm: Default None. Zeromq HighWaterMark socket option</li>
<li>zeromq_bind: Default <code>bind</code>. Whether to bind to zeromq host or simply connect</li>
</ul><p>The following are used for instances when a TransportException is thrown - Transport dependent</p>

<ul>
<li>respawn_delay: Default <code>3</code>. Initial respawn delay for exponential backoff</li>
<li>max_failure: Default <code>7</code>. Max failures before exponential backoff terminates</li>
</ul><p>The following configuration keys are for SinceDB support. Specifying these will enable saving the current line number in an sqlite database. This is useful for cases where you may be restarting the beaver process, such as during a logrotate.</p>

<ul>
<li>sincedb_path: Default <code>None</code>. Full path to an <code>sqlite3</code> database. Will be created at this path if it does not exist. Beaver process must have read and write access</li>
</ul><p>The following configuration keys are for building an SSH Tunnel that can be used to proxy from the current host to a desired server. This proxy is torn down when Beaver halts in all cases.</p>

<ul>
<li>ssh_key_file: Default <code>None</code>. Full path to <code>id_rsa</code> key file</li>
<li>ssh_tunnel: Default <code>None</code>. SSH Tunnel in the format <code>user@host:port</code>
</li>
<li>ssh_tunnel_port: Default <code>None</code>. Local port for SSH Tunnel</li>
<li>ssh_remote_host: Default <code>None</code>. Remote host to connect to within SSH Tunnel</li>
<li>ssh_remote_port: Default <code>None</code>. Remote port to connect to within SSH Tunnel</li>
</ul><p>The following can also be passed via argparse. Argparse will override all options in the configfile, when specified.</p>

<ul>
<li>format: Default <code>json</code>. Options <code>[ json, msgpack, string ]</code>. Format to use when sending to transport</li>
<li>files: Default <code>files</code>. Space-separated list of files to tail. (Comma separated if specified in the config file)</li>
<li>path: Default <code>/var/log</code>. Path glob to tail.</li>
<li>transport: Default <code>stdout</code>. Transport to use when log changes are detected</li>
<li>fqdn: Default <code>False</code>. Whether to use the machine's FQDN in transport output</li>
<li>hostname: Default <code>None</code>. Manually specified hostname</li>
</ul><h2>Examples</h2>

<p>Example 1: Listen to all files in the default path of /var/log on standard out as json::</p>

<pre><code>beaver
</code></pre>

<p>Example 2: Listen to all files in the default path of /var/log on standard out with msgpack::</p>

<pre><code>beaver --format msgpack
</code></pre>

<p>Example 3: Listen to all files in the default path of /var/log on standard out as a string::</p>

<pre><code>beaver --format string
</code></pre>

<p>Example 4: Sending logs from /var/log files to a redis list::</p>

<pre><code># /etc/beaver/conf
[beaver]
redis_url: redis://localhost:6379/0

# From the commandline
beaver  -c /etc/beaver/conf -t redis
</code></pre>

<p>Example 5: Zeromq listening on port 5556 (all interfaces)::</p>

<pre><code># /etc/beaver/conf
[beaver]
zeromq_address: tcp://*:5556

# logstash indexer config:
input {
  zeromq {
    type =&gt; 'shipper-input'
    mode =&gt; 'client'
    topology =&gt; 'pushpull'
    address =&gt; 'tcp://shipperhost:5556'
  }
}
output { stdout { debug =&gt; true } }

# From the commandline
beaver  -c /etc/beaver/conf -m bind -t zmq
</code></pre>

<p>Example 6: Zeromq connecting to remote port 5556 on indexer::</p>

<pre><code># /etc/beaver/conf
[beaver]
zeromq_address: tcp://indexer:5556

# logstash indexer config:
input {
  zeromq {
    type =&gt; 'shipper-input'
    mode =&gt; 'server'
    topology =&gt; 'pushpull'
    address =&gt; 'tcp://*:5556'
  }
}
output { stdout { debug =&gt; true } }

# on the commandline
beaver -c /etc/beaver/conf -m connect -t zmq
</code></pre>

<p>Example 7: Real-world usage of Redis as a transport::</p>

<pre><code># in /etc/hosts
192.168.0.10 redis-internal

# /etc/beaver/conf
[beaver]
redis_url: redis://redis-internal:6379/0
redis_namespace: app:unmappable

# logstash indexer config:
input {
  redis {
    host =&gt; 'redis-internal'
    data_type =&gt; 'list'
    key =&gt; 'app:unmappable'
    type =&gt; 'app:unmappable'
  }
}
output { stdout { debug =&gt; true } }

# From the commandline
beaver -c /etc/beaver/conf -f /var/log/unmappable.log -t redis
</code></pre>

<p>Example 8: RabbitMQ connecting to defaults on remote broker::</p>

<pre><code># /etc/beaver/conf
[beaver]
rabbitmq_host: 10.0.0.1

# logstash indexer config:
input { amqp {
    name =&gt; 'logstash-queue'
    type =&gt; 'direct'
    host =&gt; '10.0.0.1'
    exchange =&gt; 'logstash-exchange'
    key =&gt; 'logstash-key'
    exclusive =&gt; false
    durable =&gt; false
    auto_delete =&gt; false
  }
}
output { stdout { debug =&gt; true } }

# From the commandline
beaver -c /etc/beaver/conf -t rabbitmq
</code></pre>

<p>Example 9: Read config from config.ini and put to stdout::</p>

<pre><code># /etc/beaver/conf:
; follow a single file, add a type, some tags and fields
[/tmp/somefile]
type: mytype
tags: tag1,tag2
add_field: fieldname1,fieldvalue1[,fieldname2,fieldvalue2, ...]

; follow all logs in /var/log except those with `messages` or `secure` in the name
[/var/log/*log]
type: syslog
tags: sys
exclude: (messages,secure)

; follow /var/log/messages.log and /var/log/secure.log using file globbing
[/var/log/{messages,secure}.log]
type: syslog
tags: sys

# From the commandline
beaver -c /etc/beaver/conf -t stdout
</code></pre>

<p>Example 10: UDP transport::</p>

<pre><code># /etc/beaver/conf
[beaver]
udp_host: 127.0.0.1
udp_port: 9999

# logstash indexer config:
input {
  udp {
    type =&gt; 'shipper-input'
    host =&gt; '127.0.0.1'
    port =&gt; '9999'
  }
}
output { stdout { debug =&gt; true } }

# From the commandline
beaver -c /etc/beaver/conf -t udp
</code></pre>

<p>Example 11: SQS Transport::</p>

<pre><code># /etc/beaver/conf
[beaver]
sqs_aws_region: us-east-1
sqs_aws_queue: logstash-input
sqs_aws_access_key: &lt;access_key&gt;
sqs_aws_secret_access_key: &lt;secret_key&gt;

# logstash indexer config:
input {
  sqs {
    queue =&gt; "logstash-input"
    type =&gt; "shipper-input"
    format =&gt; "json_event"
    access_key =&gt; "&lt;access_key&gt;"
    secret_key =&gt; "&lt;secret_key&gt;"
  }
}
output { stdout { debug =&gt; true } }

# From the commandline
beaver -c /etc/beaver/conf -t sqs
</code></pre>

<p>Example 12: [Raw Json Support](<a href="http://blog.pkhamre.com/2012/08/23/logging-to-logstash-json-format-in-nginx/::">http://blog.pkhamre.com/2012/08/23/logging-to-logstash-json-format-in-nginx/::</a></p>

<pre><code>beaver --format rawjson
</code></pre>

<p>Example 13: Mqtt transport using Mosquitto::</p>

<pre><code># /etc/beaver/conf
[beaver]
mqtt_client_id: 'beaver_client'
mqtt_topic: '/logstash'
mqtt_host: '127.0.0.1'
mqtt_port: '1318'
mqtt_keepalive: '60'

# logstash indexer config:
input {
  mqtt {
    host =&gt; '127.0.0.1'
    data_type =&gt; 'list'
    key =&gt; 'app:unmappable'
    type =&gt; 'app:unmappable'
  }
}
output { stdout { debug =&gt; true } }

# From the commandline
beaver -c /etc/beaver/conf -f /var/log/unmappable.log -t mqtt
</code></pre>

<p>Example 14: Sincedb support using and sqlite3 db</p>

<p>Note that this will require R/W permissions on the file at sincedb path, as Beaver will store the current line for a given filename/file id.::</p>

<pre><code># /etc/beaver/conf
[beaver]
sincedb_path: /etc/beaver/since.db

[/var/log/syslog]
type: syslog
tags: sys,main
sincedb_write_interval: 3 ; time in seconds

# From the commandline
beaver -c /etc/beaver/conf
</code></pre>

<p>Example 15: Loading stanzas from /etc/beaver/conf.d/* support::</p>

<pre><code># /etc/beaver/conf
[beaver]
format: json

# /etc/beaver/conf.d/syslog
[/var/log/syslog]
type: syslog
tags: sys,main

# /etc/beaver/conf.d/nginx
[/var/log/nginx]
format: rawjson
type: nginx
tags: nginx,server

# From the commandline
beaver -c /etc/beaver/conf
</code></pre>

<p>As you can see, <code>beaver</code> is pretty flexible as to how you can use/abuse it in production.</p>

<h1>Todo</h1>

<ul>
<li>More documentation</li>
<li><del>Use python threading + subprocess in order to support usage of <code>yield</code> across all operating systems</del></li>
<li><del>Fix usage on non-linux platforms - file.readline() does not work as expected on OS X. See above for potential solution</del></li>
<li>More transports</li>
<li><del>Ability to specify files, tags, and other metadata within a configuration file</del></li>
</ul><h1>Caveats</h1>

<p>When using <code>copytruncate</code> style log rotation, two race conditions can occur:</p>

<ol>
<li><p>Any log data written prior to truncation which beaver has not yet
read and processed is lost. Nothing we can do about that.</p></li>
<li>
<p>Should the file be truncated, rewritten, and end up being larger than
the original file during the sleep interval, beaver won't detect
this. After some experimentation, this behavior also exists in GNU
tail, so I'm going to call this a "don't do that then" bug :)</p>

<p>Additionally, the files beaver will most likely be called upon to
watch which may be truncated are generally going to be large enough
and slow-filling enough that this won't crop up in the wild.</p>
</li>
</ol><h1>Credits</h1>

<p>Based on work from Giampaolo and Lusis::</p>

<pre><code>Real time log files watcher supporting log rotation.

Original Author: Giampaolo Rodola' &lt;g.rodola [AT] gmail [DOT] com&gt;
http://code.activestate.com/recipes/577968-log-watcher-tail-f-log/

License: MIT

Other hacks (ZMQ, JSON, optparse, ...): lusis
</code></pre>
        </section>

        <footer>
          Beaver is maintained by <a href="https://github.com/josegonzalez">josegonzalez</a><br>
          This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="http://twitter.com/jasonlong">Jason Long</a>.
        </footer>

        
      </div>
    </div>
  </body>
</html>